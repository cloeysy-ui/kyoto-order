<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>KYOTO AYCE — Order</title>
  <style>
    :root{
      --bg:#0b0c10; --panel:#12141b; --panel2:#0f1117;
      --text:#f3f6ff; --muted:#a6afc1; --accent:#f4b942;
      --danger:#ff5c7a; --ok:#33d69f; --border:rgba(255,255,255,.10);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 700px at 15% 0%, rgba(244,185,66,.16), transparent 60%),
                  radial-gradient(900px 700px at 80% 10%, rgba(51,214,159,.12), transparent 60%),
                  var(--bg);
      color:var(--text);
      padding:18px;
    }
    .wrap{max-width:1120px;margin:0 auto}
    h1{margin:0 0 10px; color:var(--accent); letter-spacing:.02em}
    .sub{color:var(--muted); margin:0 0 16px; font-size:13px}
    .grid{display:grid; grid-template-columns: 1.4fr .6fr; gap:14px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
    .panel{
      background: rgba(18,20,27,.85);
      border:1px solid var(--border);
      border-radius: var(--radius);
      overflow:hidden;
    }
    .ph{padding:14px 14px 10px; border-bottom:1px solid var(--border)}
    .pb{padding:14px}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end}
    label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px}
    input{
      width: 180px; max-width:100%;
      padding:10px 12px; border-radius:12px;
      background: rgba(255,255,255,.04);
      border:1px solid var(--border);
      color:var(--text);
      outline:none;
    }
    input:focus{border-color: rgba(244,185,66,.7)}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      color:var(--muted);
      font-size:12px;
    }
    .pill b{color:var(--text)}
    .pill.ok{border-color: rgba(51,214,159,.55); background: rgba(51,214,159,.10)}
    .pill.danger{border-color: rgba(255,92,122,.55); background: rgba(255,92,122,.10)}
    .tabs{display:flex; gap:8px; flex-wrap:wrap; padding:12px 14px; border-bottom:1px solid var(--border); background: rgba(255,255,255,.02)}
    .tab{
      cursor:pointer; user-select:none;
      padding:8px 10px; border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted); font-size:13px;
    }
    .tab.active{color:var(--text); border-color: rgba(244,185,66,.7); background: rgba(244,185,66,.12)}
    .menu{
      padding:14px;
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap:12px;
    }
    .card{
      background: rgba(15,17,23,.9);
      border:1px solid var(--border);
      border-radius: 14px;
      overflow:hidden;
      display:flex; flex-direction:column;
      min-height: 160px;
    }
    .thumb{
      height:70px;
      background:
        radial-gradient(240px 120px at 20% 20%, rgba(244,185,66,.22), transparent 55%),
        radial-gradient(220px 120px at 80% 10%, rgba(51,214,159,.15), transparent 55%),
        linear-gradient(135deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border-bottom:1px solid var(--border);
      padding:10px 12px;
      display:flex; align-items:flex-end; justify-content:space-between;
    }
    .code{font-weight:900; font-size:12px; letter-spacing:.08em; padding:5px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.18)}
    .tag{font-size:12px; padding:5px 8px; border-radius:999px; border:1px solid var(--border); color:var(--muted)}
    .tag.premium{border-color: rgba(255,92,122,.55); background: rgba(255,92,122,.10); color:#ffd1da}
    .tag.sashimi{border-color: rgba(66,165,245,.55); background: rgba(66,165,245,.10); color:#d7f1ff}
    .cb{padding:12px; display:flex; flex-direction:column; gap:10px; flex:1}
    .name{font-weight:800}
    .desc{color:var(--muted); font-size:12px}
    .qty{margin-top:auto; display:flex; align-items:center; justify-content:space-between; gap:8px}
    .stepper{display:flex; align-items:center; gap:6px; padding:4px; border:1px solid var(--border); border-radius:999px; background: rgba(255,255,255,.02)}
    .stepper button{
      width:30px; height:30px; border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      color:var(--text); cursor:pointer;
    }
    .stepper span{min-width:26px; text-align:center; font-weight:900}
    .side .pb{display:flex; flex-direction:column; gap:12px}
    .kpi{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .box{border:1px solid var(--border); border-radius:14px; padding:10px 12px; background: rgba(255,255,255,.02)}
    .num{font-size:20px; font-weight:950}
    .lbl{font-size:12px; color:var(--muted)}
    .btn{
      padding:12px 12px; border-radius:12px;
      border:1px solid rgba(244,185,66,.65);
      background: rgba(244,185,66,.14);
      color:var(--text); cursor:pointer;
      font-weight:800;
    }
    .btn:disabled{opacity:.45; cursor:not-allowed}
    .btn.secondary{
      border-color: var(--border);
      background: rgba(255,255,255,.03);
      font-weight:700;
    }
    .hint{font-size:12px; color:var(--muted); line-height:1.35}
    textarea{
      width:100%; min-height:120px; resize:vertical;
      padding:10px 12px; border-radius:12px;
      background: rgba(255,255,255,.03);
      border:1px solid var(--border);
      color:var(--text);
    }
    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background: rgba(0,0,0,.55);
      border:1px solid var(--border);
      backdrop-filter: blur(10px);
      padding:10px 12px;
      border-radius:999px;
      color:var(--text);
      font-size:13px;
      display:none;
    }
  </style>
</head>
<body>
<div class="wrap">
  <h1>KYOTO All You Can Eat</h1>
  <p class="sub">Max <b>5 dishes</b> per guest per round · Premium max <b>2</b> per guest · Same table must wait <b>15 mins</b> between rounds</p>

  <div class="grid">
    <!-- MAIN -->
    <div class="panel">
      <div class="ph">
        <div class="row">
          <div>
            <label>Table</label>
            <input id="tableId" placeholder="e.g. 12"/>
          </div>
          <div>
            <label>Guests</label>
            <input id="guests" type="number" min="1" value="1"/>
          </div>

          <div class="pill ok" id="statusPill">Status: <b>Ready</b></div>
          <div class="pill" id="roundPill">Round: <b id="roundNum">1</b></div>
          <div class="pill danger" id="cooldownPill" style="display:none;">Next round in <b id="cooldownText">15:00</b></div>
        </div>
      </div>

      <div class="tabs" id="tabs"></div>
      <div class="menu" id="menu"></div>
    </div>

    <!-- SIDE -->
    <div class="panel side">
      <div class="ph">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;">
          <div>
            <div style="font-weight:900;">Cart summary</div>
            <div class="hint">Pick quantities then confirm. JSON will be prepared for your kitchen / print API.</div>
          </div>
          <button class="btn secondary" id="resetBtn" type="button">Reset cart</button>
        </div>
      </div>

      <div class="pb">
        <div class="kpi">
          <div class="box">
            <div class="num" id="kpiTotal">0</div>
            <div class="lbl">Total dishes (<= guests×5)</div>
          </div>
          <div class="box">
            <div class="num" id="kpiPremium">0</div>
            <div class="lbl">Premium (<= guests×2)</div>
          </div>
        </div>

        <button class="btn" id="confirmBtn" type="button">Confirm Order</button>

        <div class="hint">
          • If you open link like <b>?table=12</b>, table is auto-filled.<br/>
          • Cooldown & rounds are saved per table (even if page refreshes).<br/>
          • This demo logs JSON to console and shows it below.
        </div>

        <textarea id="jsonOut" placeholder="Order JSON will appear here after confirm..." readonly></textarea>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/** ====== CONFIG (your rules) ====== **/
const RULES = {
  maxDishesPerGuest: 5,
  cooldownMinutes: 15
};

/** ====== MENU DATA (replace with your full menu later) ====== **/
const MENU = [
  // ===== Deluxe Sushi Menu / Nigiri & Gunkan (2 pcs) =====
  { code:"01", name:"Salmon (Nigiri)", cat:"Deluxe Sushi", desc:"£5.00", countsTowardLimit:true },
  { code:"02", name:"Tuna (Nigiri)", cat:"Deluxe Sushi", desc:"£5.80", countsTowardLimit:true },
  { code:"03", name:"Shrimp (Nigiri)", cat:"Deluxe Sushi", desc:"£5.00", countsTowardLimit:true },
  { code:"04", name:"Ama Ebi (Sweet shrimp)", cat:"Deluxe Sushi", desc:"£5.80", countsTowardLimit:true },
  { code:"05", name:"Eel (Unagi)", cat:"Deluxe Sushi", desc:"£5.80", countsTowardLimit:true },
  { code:"06", name:"Octopus", cat:"Deluxe Sushi", desc:"£5.80", countsTowardLimit:true },
  { code:"07", name:"Crab Stick", cat:"Deluxe Sushi", desc:"£4.80", countsTowardLimit:true },
  { code:"08", name:"Tofu", cat:"Deluxe Sushi", desc:"£4.80", countsTowardLimit:true },
  { code:"09", name:"Avocado", cat:"Deluxe Sushi", desc:"£4.80", countsTowardLimit:true },
  { code:"10", name:"Tamago (Egg)", cat:"Deluxe Sushi", desc:"£4.80", countsTowardLimit:true },
  { code:"11", name:"Gunkan Seaweed", cat:"Deluxe Sushi", desc:"£5.00", countsTowardLimit:true },
  { code:"12", name:"Gunkan Salmon", cat:"Deluxe Sushi", desc:"£5.00", countsTowardLimit:true },
  { code:"13", name:"Gunkan Tuna", cat:"Deluxe Sushi", desc:"£5.00", countsTowardLimit:true },
  { code:"14", name:"Gunkan Tobiko", cat:"Deluxe Sushi", desc:"£5.00", countsTowardLimit:true },
  { code:"15", name:"Surfclam", cat:"Deluxe Sushi", desc:"£5.80", countsTowardLimit:true },
  { code:"16", name:"Flamed Tuna", cat:"Deluxe Sushi", desc:"£5.80", countsTowardLimit:true },
  { code:"17", name:"Flamed Seabass", cat:"Deluxe Sushi", desc:"£5.50", countsTowardLimit:true },
  { code:"18", name:"Flamed Beef", cat:"Deluxe Sushi", desc:"£5.50", countsTowardLimit:true },
  { code:"19", name:"Flamed Salmon", cat:"Deluxe Sushi", desc:"£5.50", countsTowardLimit:true },

  // ===== Hand Roll (1 pc) =====
  { code:"20", name:"Vegan Hand Roll", cat:"Hand Roll", desc:"£5.00", countsTowardLimit:true },
  { code:"21", name:"California Hand Roll", cat:"Hand Roll", desc:"£5.00", countsTowardLimit:true },
  { code:"22", name:"Salmon Avocado Hand Roll", cat:"Hand Roll", desc:"£5.00", countsTowardLimit:true },
  { code:"23", name:"Tuna Hand Roll", cat:"Hand Roll", desc:"£5.00", countsTowardLimit:true },
  { code:"24", name:"Eel Hand Roll", cat:"Hand Roll", desc:"£6.00", countsTowardLimit:true },
  { code:"25", name:"Hawaii (Prawn) Hand Roll", cat:"Hand Roll", desc:"£5.00", countsTowardLimit:true },
  { code:"26", name:"Soft Shell Crab Hand Roll", cat:"Hand Roll", desc:"£6.00", countsTowardLimit:true },

  // ===== Maki (3 pcs) =====
  { code:"27", name:"Cucumber Maki", cat:"Maki", desc:"£2.50", countsTowardLimit:true },
  { code:"28", name:"Crab Stick Maki", cat:"Maki", desc:"£2.50", countsTowardLimit:true },
  { code:"29", name:"Salmon Maki", cat:"Maki", desc:"£3.00", countsTowardLimit:true },
  { code:"30", name:"Egg Maki", cat:"Maki", desc:"£2.50", countsTowardLimit:true },
  { code:"31", name:"Tuna Maki", cat:"Maki", desc:"£3.00", countsTowardLimit:true },
  { code:"32", name:"Avocado Maki", cat:"Maki", desc:"£2.50", countsTowardLimit:true },

  // ===== Uramaki Rolls (2 pcs) =====
  { code:"33", name:"Salmon Roll", cat:"Uramaki Rolls", desc:"£3.50", countsTowardLimit:true },
  { code:"34", name:"Spicy Salmon Roll", cat:"Uramaki Rolls", desc:"£3.50", countsTowardLimit:true },
  { code:"35", name:"Tuna Roll", cat:"Uramaki Rolls", desc:"£3.60", countsTowardLimit:true },
  { code:"36", name:"Spicy Tuna Roll", cat:"Uramaki Rolls", desc:"£3.60", countsTowardLimit:true },
  { code:"37", name:"California Roll", cat:"Uramaki Rolls", desc:"£3.50", countsTowardLimit:true },
  { code:"38", name:"Crunchy Prawn Roll", cat:"Uramaki Rolls", desc:"£4.00", countsTowardLimit:true },
  { code:"39", name:"Crispy Tempura Roll", cat:"Uramaki Rolls", desc:"£3.50", countsTowardLimit:true },
  { code:"40", name:"Chicken Roll", cat:"Uramaki Rolls", desc:"£4.00", countsTowardLimit:true },
  { code:"41", name:"Beef Roll", cat:"Uramaki Rolls", desc:"£4.00", countsTowardLimit:true },
  { code:"42", name:"Vegan Roll", cat:"Uramaki Rolls", desc:"£4.00", countsTowardLimit:true },

  // ===== Kyoto Signature Rolls (Exclusive for AYCE) =====
  { code:"43", name:"Avo-Licious Veggie Roll", cat:"Kyoto Signature Rolls", desc:"£4.50", countsTowardLimit:true },
  { code:"44", name:"Mango Tango Roll", cat:"Kyoto Signature Rolls", desc:"£4.50", countsTowardLimit:true },
  { code:"45", name:"Salmon Prawn Delight Roll", cat:"Kyoto Signature Rolls", desc:"£4.50", countsTowardLimit:true },
  { code:"46", name:"Dragon’s Breath Wakame Roll", cat:"Kyoto Signature Rolls", desc:"£4.50", countsTowardLimit:true },
  { code:"47", name:"Tiger Roll", cat:"Kyoto Signature Rolls", desc:"£4.50", countsTowardLimit:true },
  { code:"48", name:"Seared Seabass Fury Roll", cat:"Kyoto Signature Rolls", desc:"£4.50", countsTowardLimit:true },
  { code:"49", name:"Supreme Dragon Roll", cat:"Kyoto Signature Rolls", desc:"£4.50", countsTowardLimit:true },
  { code:"50", name:"Inferno Roll (Unagi)", cat:"Kyoto Signature Rolls", desc:"£4.50", countsTowardLimit:true },
  { code:"51", name:"4 Seas Rainbow Roll", cat:"Kyoto Signature Rolls", desc:"£4.50", countsTowardLimit:true },
  { code:"52", name:"Spicy Tuna Crunch Roll", cat:"Kyoto Signature Rolls", desc:"£4.50", countsTowardLimit:true },
  { code:"53", name:"Salmon Philadelphia Roll", cat:"Kyoto Signature Rolls", desc:"£4.50", countsTowardLimit:true },
  { code:"54", name:"Ultimate Spider Roll", cat:"Kyoto Signature Rolls", desc:"£4.50", countsTowardLimit:true },

  // ===== Sashimi (PAID add-on, per lb) =====
  { code:"55", name:"Salmon Sashimi", cat:"Sashimi (Paid)", desc:"£1 per lb", paid:true, unit:"lb", pricePerUnit:1.0, countsTowardLimit:false },
  { code:"56", name:"Tuna Sashimi", cat:"Sashimi (Paid)", desc:"£1.50 per lb", paid:true, unit:"lb", pricePerUnit:1.5, countsTowardLimit:false },

  // ===== Rice, Noodle Soup & Veggies =====
  { code:"57", name:"Tsurai Beef Rice", cat:"Rice & Noodles", desc:"£10.50", countsTowardLimit:true },
  { code:"58", name:"Chicken Katsu Rice", cat:"Rice & Noodles", desc:"£10.50", countsTowardLimit:true },
  { code:"59", name:"Kyoto Tonkotsu Ramen Soup", cat:"Rice & Noodles", desc:"£12.50", countsTowardLimit:true },
  { code:"60", name:"Fried Chicken Ramen Soup", cat:"Rice & Noodles", desc:"£11.50", countsTowardLimit:true },
  { code:"61", name:"Vegan Udon Soup", cat:"Rice & Noodles", desc:"£10.50", countsTowardLimit:true },
  { code:"62", name:"Vegetable Mix", cat:"Veggies", desc:"£6.50", countsTowardLimit:true },
  { code:"63", name:"Mikkusu Mushrooms", cat:"Veggies", desc:"£6.50", countsTowardLimit:true },
  { code:"64", name:"Zukkini (Hot & Spicy)", cat:"Veggies", desc:"£6.50", countsTowardLimit:true },

  // ===== Deep Fried =====
  { code:"65", name:"Korean Honey Chicken", cat:"Deep Fried", desc:"£5.00", countsTowardLimit:true },
  { code:"66", name:"Fried Veggie Mix", cat:"Deep Fried", desc:"£5.00", countsTowardLimit:true },
  { code:"67", name:"Panko Calamari", cat:"Deep Fried", desc:"£5.00", countsTowardLimit:true },
  { code:"68", name:"Ebi Fry", cat:"Deep Fried", desc:"£5.00", countsTowardLimit:true },
  { code:"69", name:"Karaage Salmon", cat:"Deep Fried", desc:"£5.00", countsTowardLimit:true },
  { code:"70", name:"Takoyaki Balls", cat:"Deep Fried", desc:"£6.00", countsTowardLimit:true },
  { code:"71", name:"Bao Chicken", cat:"Deep Fried", desc:"£6.00", countsTowardLimit:true },
  { code:"72", name:"Bao Fish", cat:"Deep Fried", desc:"£6.00", countsTowardLimit:true },
  { code:"73", name:"Chicken Debasaki", cat:"Deep Fried", desc:"£5.50", countsTowardLimit:true },
  { code:"74", name:"Korean Chicken Wings", cat:"Deep Fried", desc:"£5.50", countsTowardLimit:true },
  { code:"75", name:"Karaage Fish", cat:"Deep Fried", desc:"£6.00", countsTowardLimit:true },
  { code:"76", name:"Tempura Green Beans & Veggies", cat:"Deep Fried", desc:"£5.50", countsTowardLimit:true },
  { code:"77", name:"Crabclaws", cat:"Deep Fried", desc:"£5.50", countsTowardLimit:true },
  { code:"78", name:"Sesame Prawn Toast", cat:"Deep Fried", desc:"£5.50", countsTowardLimit:true },
  { code:"79", name:"Torpedo Shrimp Spring Roll", cat:"Deep Fried", desc:"£5.50", countsTowardLimit:true },

  // ===== Soups & Salad =====
  { code:"80", name:"Miso Soup", cat:"Soups & Salad", desc:"£4.50", countsTowardLimit:true },
  { code:"81", name:"Seafood Soup", cat:"Soups & Salad", desc:"£4.50", countsTowardLimit:true },
  { code:"82", name:"Wakame Salad", cat:"Soups & Salad", desc:"£6.00", countsTowardLimit:true },
  { code:"83", name:"Tataki Beef Salad", cat:"Soups & Salad", desc:"£8.00", countsTowardLimit:true },
  { code:"84", name:"Ebi Mango Salad", cat:"Soups & Salad", desc:"£8.00", countsTowardLimit:true },

  // ===== Teppan Grilled & Lava Stone BBQ =====
  { code:"85", name:"Yaki Salmon", cat:"Teppan & BBQ", desc:"£5.50", countsTowardLimit:true },
  { code:"86", name:"Chicken Gyoza", cat:"Teppan & BBQ", desc:"£5.50", countsTowardLimit:true },
  { code:"87", name:"Beef Bulgogi", cat:"Teppan & BBQ", desc:"£6.50", countsTowardLimit:true },
  { code:"88", name:"Squid Rings No Guriru", cat:"Teppan & BBQ", desc:"£7.00", countsTowardLimit:true },
  { code:"89", name:"Guriru Mussels", cat:"Teppan & BBQ", desc:"£6.50", countsTowardLimit:true },
  { code:"90", name:"Usuyaki Beef Rolls", cat:"Teppan & BBQ", desc:"£6.50", countsTowardLimit:true },
  { code:"91", name:"Okonomiyaki Seafood", cat:"Teppan & BBQ", desc:"£10.50", countsTowardLimit:true },
  { code:"92", name:"Okonomiyaki Veggie Supreme", cat:"Teppan & BBQ", desc:"£10.50", countsTowardLimit:true },
  { code:"93", name:"Ribeye", cat:"Teppan & BBQ", desc:"£8.50", countsTowardLimit:true },
  { code:"94", name:"Yakitori Chicken", cat:"Teppan & BBQ", desc:"£7.00", countsTowardLimit:true },
  { code:"95", name:"Kushi Shrimp", cat:"Teppan & BBQ", desc:"£7.50", countsTowardLimit:true },
  { code:"96", name:"Kushi Squid", cat:"Teppan & BBQ", desc:"£7.50", countsTowardLimit:true },
  { code:"97", name:"Lambchop Babekyu", cat:"Teppan & BBQ", desc:"£7.50", countsTowardLimit:true },
  { code:"98", name:"Chicken Wings BBQ Sauce", cat:"Teppan & BBQ", desc:"£5.50", countsTowardLimit:true },

  // ===== Sweets & Desserts =====
  { code:"99", name:"Tempura Banana", cat:"Dessert", desc:"£4.50", countsTowardLimit:true },
  { code:"100", name:"Sweet Anpan Buns", cat:"Dessert", desc:"£4.50", countsTowardLimit:true },
  { code:"101", name:"Tempura Lychee", cat:"Dessert", desc:"£4.00", countsTowardLimit:true },
  { code:"102", name:"Ice Cream (choose 1 flavor, 1 per person)", cat:"Dessert", desc:"£2.00", countsTowardLimit:true },
  { code:"103", name:"Sesame Balls", cat:"Dessert", desc:"£3.50", countsTowardLimit:true },
  { code:"104", name:"Japanese Panacotta (1 per person, limited)", cat:"Dessert", desc:"£5.50", countsTowardLimit:true },

  // ===== Sides (free each round, not within limit) =====
  { code:"105", name:"Edamame", cat:"Sides", desc:"£4.00", countsTowardLimit:false },
  { code:"106", name:"Takuan Cucumber", cat:"Sides", desc:"£4.00", countsTowardLimit:false },
  { code:"107", name:"Yaki Meshi", cat:"Sides", desc:"£4.50", countsTowardLimit:false },
  { code:"108", name:"Gohan (Rice)", cat:"Sides", desc:"£3.00", countsTowardLimit:false },
  { code:"109", name:"Yaki Udon", cat:"Sides", desc:"£4.50", countsTowardLimit:false },
  { code:"110", name:"Fries", cat:"Sides", desc:"£4.00", countsTowardLimit:false },
];
/** ====== STATE ====== **/
let activeCat = "All";
let cart = {}; // code -> qty

/** ====== UTIL ====== **/
const $ = (id)=>document.getElementById(id);

function toast(msg){
  const t = $("toast");
  t.textContent = msg;
  t.style.display = "block";
  clearTimeout(window.__toastTimer);
  window.__toastTimer = setTimeout(()=>t.style.display="none", 2200);
}

function getQueryParam(name){
  const url = new URL(window.location.href);
  return url.searchParams.get(name);
}

function keyFor(table){ return `kyoto_ayce_${table}`; } // localStorage key per table

function loadTableState(table){
  try{
    const raw = localStorage.getItem(keyFor(table));
    return raw ? JSON.parse(raw) : null;
  }catch(e){ return null; }
}

function saveTableState(table, state){
  localStorage.setItem(keyFor(table), JSON.stringify(state));
}

function ensureTableState(table){
  let st = loadTableState(table);
  if(!st){
    st = { lastOrderAt: 0, round: 1 };
    saveTableState(table, st);
  }
  return st;
}

function msToMMSS(ms){
  const s = Math.max(0, Math.floor(ms/1000));
  const mm = String(Math.floor(s/60)).padStart(2,"0");
  const ss = String(s%60).padStart(2,"0");
  return `${mm}:${ss}`;
}

/** ====== RENDER ====== **/
function categories(){
  const set = new Set(MENU.map(m=>m.cat));
  return ["All", ...Array.from(set)];
}

function renderTabs(){
  const t = $("tabs");
  t.innerHTML = "";
  categories().forEach(cat=>{
    const el = document.createElement("div");
    el.className = "tab" + (cat===activeCat ? " active":"");
    el.textContent = cat;
    el.onclick = ()=>{ activeCat = cat; renderMenu(); renderTabs(); };
    t.appendChild(el);
  });
}

function renderMenu(){
  const wrap = $("menu");
  wrap.innerHTML = "";
  const list = MENU.filter(m=> activeCat==="All" ? true : m.cat===activeCat);

  list.forEach(item=>{
    const qty = cart[item.code] || 0;
    const card = document.createElement("div");
    card.className = "card";

    const tags = [];
    if(item.premium) tags.push(`<span class="tag premium">Premium</span>`);
    if(item.sashimi) tags.push(`<span class="tag sashimi">Sashimi</span>`);

    card.innerHTML = `
      <div class="thumb">
        <span class="code">${item.code}</span>
        <div style="display:flex;gap:6px;align-items:center;">${tags.join("")}</div>
      </div>
      <div class="cb">
        <div class="name">${item.name}</div>
        <div class="desc">${item.desc || ""}</div>
        <div class="qty">
          <span class="pill">Qty</span>
          <div class="stepper">
            <button type="button" data-act="dec" data-code="${item.code}">-</button>
            <span id="q_${item.code}">${qty}</span>
            <button type="button" data-act="inc" data-code="${item.code}">+</button>
          </div>
        </div>
      </div>
    `;
    wrap.appendChild(card);
  });

  wrap.querySelectorAll("button[data-act]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const code = btn.getAttribute("data-code");
      const act = btn.getAttribute("data-act");
      const nowQty = cart[code] || 0;
      cart[code] = Math.max(0, nowQty + (act==="inc" ? 1 : -1));
      if(cart[code]===0) delete cart[code];
      const span = document.getElementById(`q_${code}`);
      if(span) span.textContent = String(cart[code] || 0);
      renderKPIs();
    });
  });
}

function counts(){
  let total = 0, premium = 0;
  for(const [code, qty] of Object.entries(cart)){
    total += qty;
    const item = MENU.find(m=>m.code===code);
    if(item && item.premium) premium += qty;
  }
  return { total, premium };
}

function renderKPIs(){
  const g = parseInt($("guests").value || "1", 10);
  const {total, premium} = counts();
  $("kpiTotal").textContent = total;
  $("kpiPremium").textContent = premium;

  const maxTotal = g * RULES.maxDishesPerGuest;
  const maxPrem = g * RULES.maxPremiumPerGuest;

  // soft warnings
  if(total > maxTotal) toast(`Over limit: total must be ≤ ${maxTotal}`);
  if(premium > maxPrem) toast(`Over limit: premium must be ≤ ${maxPrem}`);
}

/** ====== COOLDOWN / ROUND ====== **/
let cooldownTimer = null;

function updateCooldownUI(){
  const table = $("tableId").value.trim();
  if(!table) return;

  const st = ensureTableState(table);
  $("roundNum").textContent = String(st.round || 1);

  const now = Date.now();
  const cdMs = RULES.cooldownMinutes * 60 * 1000;
  const remain = (st.lastOrderAt ? (st.lastOrderAt + cdMs - now) : 0);

  const inCooldown = remain > 0;

  $("cooldownPill").style.display = inCooldown ? "inline-flex" : "none";
  if(inCooldown){
    $("cooldownText").textContent = msToMMSS(remain);
    $("statusPill").className = "pill danger";
    $("statusPill").innerHTML = `Status: <b>Cooldown</b>`;
  }else{
    $("statusPill").className = "pill ok";
    $("statusPill").innerHTML = `Status: <b>Ready</b>`;
  }

  $("confirmBtn").disabled = inCooldown;

  // keep ticking
  if(cooldownTimer) clearTimeout(cooldownTimer);
  cooldownTimer = setTimeout(updateCooldownUI, 500);
}

/** ====== ORDER SUBMIT ====== **/
function validate(){
  const table = $("tableId").value.trim();
  if(!table){ toast("Please enter table"); return false; }
  const guests = parseInt($("guests").value || "1", 10);
  if(!guests || guests<1){ toast("Guests must be >= 1"); return false; }

  const st = ensureTableState(table);
  const cdMs = RULES.cooldownMinutes * 60 * 1000;
  if(st.lastOrderAt && Date.now() < st.lastOrderAt + cdMs){
    toast("Still in cooldown");
    return false;
  }

  const {total, premium} = counts();
  if(total === 0){ toast("Cart is empty"); return false; }

  const maxTotal = guests * RULES.maxDishesPerGuest;
  const maxPrem = guests * RULES.maxPremiumPerGuest;
  if(total > maxTotal){ toast(`Total over limit (≤ ${maxTotal})`); return false; }
  if(premium > maxPrem){ toast(`Premium over limit (≤ ${maxPrem})`); return false; }

  return true;
}

function buildOrder(){
  const table = $("tableId").value.trim();
  const guests = parseInt($("guests").value || "1", 10);
  const st = ensureTableState(table);

  const items = Object.entries(cart).map(([code, qty])=>{
    const m = MENU.find(x=>x.code===code);
    return {
      code,
      name: m ? m.name : code,
      qty,
      premium: !!(m && m.premium),
      cat: m ? m.cat : ""
    };
  });

  return {
    table,
    guests,
    round: st.round || 1,
    rules: RULES,
    items,
    timestamp: new Date().toISOString()
  };
}

function afterSubmit(){
  const table = $("tableId").value.trim();
  const st = ensureTableState(table);

  st.lastOrderAt = Date.now();
  st.round = (st.round || 1) + 1;
  saveTableState(table, st);

  cart = {};
  renderMenu();
  renderKPIs();
  updateCooldownUI();
}

$("confirmBtn").addEventListener("click", ()=>{
  if(!validate()) return;

  const order = buildOrder();
  const json = JSON.stringify(order, null, 2);
  $("jsonOut").value = json;

  // TODO: replace console.log with your Kitchen/Print API
  console.log("Order JSON:", order);

  toast("Order sent (JSON prepared)");
  afterSubmit();
});

$("resetBtn").addEventListener("click", ()=>{
  cart = {};
  renderMenu();
  renderKPIs();
  toast("Cart reset");
});

/** ====== INIT ====== **/
(function init(){
  // auto-fill table from ?table=12
  const t = getQueryParam("table");
  if(t) $("tableId").value = t;

  renderTabs();
  renderMenu();
  renderKPIs();

  $("tableId").addEventListener("input", ()=>{
    updateCooldownUI();
  });
  $("guests").addEventListener("input", ()=>{
    renderKPIs();
  });

  // start cooldown ticker if table already set
  updateCooldownUI();
})();
</script>
</body>
</html>
